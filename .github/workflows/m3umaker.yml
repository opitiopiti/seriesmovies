name: M3U MAKER

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'    # Her 5 saatte bir tÃ¼m scriptler Ã§alÄ±ÅŸÄ±r

jobs:
  notify_start:
    name: ðŸ”” Telegram Start Notify
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram start message
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="ðŸ”” M3U workflow baÅŸladÄ±!"
          
          curl -s -o /dev/null -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE"
            
  part1:
    name: Step 1-3 Ã‡alÄ±ÅŸtÄ±r
    runs-on: ubuntu-latest
#    needs: notify_start
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-cache-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-cache-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      - name: Install Shared Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml playwright aiohttp aiofiles dotenv zstandard cloudscraper python-dateutil
          playwright install

      # 1. CanlÄ± YayÄ±n ve EPG Ã¼retimi
      - name: Run Vavoo YayÄ±nlarÄ±.py
        run: python private_py/vavoo/iptv/vavooiptvkendi.py

      - name: Run GunlukSporAkÄ±sÄ±.py
        run: python private_py/channels/gunluksporakÄ±sÄ±/tvyayinakisi.py || true

      - name: Run epg.py
        run: python private_py/channels/epg/gunlukepg.py || true

      - name: Run sendes.py
        run: python private_py/series/sendes/yenibolumler.py || true

      # 2. TV Dizileri
      - name: Run yereldiziler.py
        run: python private_py/series/yereldiziler/yereldiziler.py || true

      # 2. RECTV Yerli Diziler
      - name: Run rectv.py
        run: python private_py/series/rectv/yenibolumler.py || true

      - name: Commit and Push EPG to public repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add xtream/tum_kanallar.xml xtream/tum_kanallar.gz || echo "No files"
          git commit -m "GÃ¼nlÃ¼k EPG gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main

      - name: Sync M3U outputs to private repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/m3u8file.git privaate_m3u8file

          cp v/vavoo.m3u privaate_m3u8file/vavoo.m3u || echo "v/vavoo.m3u bulunamadÄ±"
          cp v/vavoo_turkey.m3u privaate_m3u8file/vavoo_turkey.m3u || echo "v/vavoo_turkey.m3u bulunamadÄ±"
          cp gunluk_spor.m3u privaate_m3u8file/gunluk_spor.m3u || echo "gunluk_spor.m3u bulunamadÄ±"
          cp televizyondizileri.m3u privaate_m3u8file/televizyondizileri.m3u || echo "televizyondizileri.m3u bulunamadÄ±"
          cp sendes.m3u privaate_m3u8file/sendes.m3u || echo "sendes.m3u bulunamadÄ±"
          cp rectv_yerli_diziler.m3u privaate_m3u8file/rectv_yerli_diziler.m3u || echo "rectv_yerli_diziler.m3u bulunamadÄ±"

          cd privaate_m3u8file
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto playlist update" || echo "No changes"
          git push origin main

      # 3. Run All JSON
      - name: Run Dizigom JSON Script
        run: python private_py/series/dizigom/dizigomdizijson.py || true

      - name: Run Sezonlukdizi JSON Script
        run: python private_py/series/sezonlukdizi/tumdizilerjson.py || true

      - name: Run Anizm JSON Script
        run: python private_py/anime/anizm/anizimjson.py || true

      - name: Run AnimeNoSub JSON Script
        run: python private_py/anime/ingilizce/animenosub/animenosubjson.py || true

      - name: Run SetfilmÄ°zleDizi JSON Script
        run: python private_py/series/setfilmizledizi/setfilmizledizijson.py || true

      - name: Run Dizipall JSON Script
        run: python private_py/series/dizipall/jsonyonlendirmeguncelleme.py || true

      - name: Run HDFilmCehennemi JSON Script
        run: python private_py/series/hdfilmcehennemi/dizilerjson.py || true

      - name: Run DiziYo JSON Script
        run: python private_py/series/diziyo/diziyojson.py || true

      - name: Run YabancÄ±Diziler JSON Script
        run: python private_py/series/yabancidiziler/dizilerjson.py || true

      - name: Commit and Push All JSONs to public repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dizigom/*.json || echo "No dizigom files"
          git add sdizi/*.json || echo "No sezonlukdizi files"
          git add anizm/*.json || echo "No anizm files"
          git add animenosub/*.json || echo "No animenosub files"
          git add setfilmizledizi/*.json || echo "No setfilmizledizi files"
          git add diziyo/*.json || echo "No diziyo files"
          git add hdfilmcehennemi/*.json || echo "No hdfilmcehennemi files"
          git add yabancidiziler/*.json || echo "No yabancidiziler files"
          git add dizipall/diziler.json || echo "No diziyo files"
          git commit -m "All JSON gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main

  part2:
    name: Step 4 Ã‡alÄ±ÅŸtÄ±r
    runs-on: ubuntu-latest
    needs: part1
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      - name: Install Shared Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      # 4. DÄ°ZÄ°LER KATEGORÄ° GÃœNCELLEME
      - name: Run series_kategori_guncelleme Script
        run: python private_py/series/category.py

      - name: Commit and Push Ana JSONs to public repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add xtream/series_category.json || echo "No files"
          git commit -m "Series Category JSON gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          
  part3:
    name: Step 5-to-15 Ã‡alÄ±ÅŸtÄ±r (Paralel)
    runs-on: ubuntu-latest
    needs: part2
    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      - name: Install Shared Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml playwright aiohttp aiofiles dotenv httpx
          playwright install

      - name: Run Scripts in Controlled Parallel Batches
        run: |
          set +e
      
          echo "ðŸ”„ Batch 1 baÅŸlÄ±yor (HDFilmSite & Anizm & AnimeNoSub & SetFilmÄ°zle & Diziyo)"
          ( python private_py/series/hdfilmsite/yenibolumler.py || true ) &
          ( python private_py/anime/ingilizce/animeheaven/yenibolumler.py || true ) &
          ( python private_py/anime/ingilizce/animenosub/yenibolumler.py || true ) &
          ( python private_py/series/setfilmizledizi/yenibolumler.py || true ) &
          ( python private_py/series/diziyo/yenibolumler.py || true ) &
          wait
      
          echo "ðŸ”„ Batch 2 baÅŸlÄ±yor (Dizigom & Dizipall & HDFilmCehennemi & YabancÄ±Diziler & Dizipal)"
          ( python private_py/series/dizigom/yenibolumler.py || true ) &
          ( python private_py/series/dizipall/yenibolumler.py || true ) &
          ( python private_py/series/sezonlukdizi/yenibolumler.py || true ) &
          ( python private_py/series/yabancidiziler/yenibolumler.py || true ) &
          ( python private_py/series/dizipal/yenibolumler.py || true ) &
          wait
      
          echo "ðŸ”„ Batch 3 baÅŸlÄ±yor (SezonlukDizi & AnimeHeaven & DiziLife & Tlc & Dmax)"
          
          # Ã‡alÄ±ÅŸtÄ±rÄ±lacak scriptler
          ( python private_py/series/hdfilmcehennemi/yenibolumler.py || true ) &          
          ( python private_py/series/dizilife/yenibolumler.py || true ) &
          # ( python private_py/anime/anizm/yenibolumler.py || true ) & # Kod hatasÄ± mevcut ÅŸuanda Ã§Ã¶zmeye gerek yok
          
          wait
          
          echo "âœ… TÃ¼m scriptler tamamlandÄ±.."

      - name: Commit and Push All JSONs
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git config status.showUntrackedFiles no
          git add **/*.json || echo "No JSON files"
          git commit -m "TÃ¼m JSON dosyalarÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          
          # Retry push up to 5 times with 10s delay
          for i in {1..5}; do
            git push origin main && break
            echo "Push failed, retrying in 10s..."
            sleep 10
          done

      - name: Sync Outputs to Private Repos
        run: |
          # Dizigom
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/dizigom.git private_dizigom
          rsync -a dizigom/ private_dizigom/
          cd private_dizigom
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "Dizigom Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # Anizm
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/anizm.git private_anizm
          rsync -a anizm/ private_anizm/
          cd private_anizm
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "Anizm Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # AnimeNoSub
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/animenosub.git private_animenosub
          rsync -a animenosub/ private_animenosub/
          cd private_animenosub
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "AnimeNoSub Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # SetFilmÄ°zleDizi
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/setfilmizledizi.git private_setfilmizledizi
          rsync -a setfilmizledizi/ private_setfilmizledizi/
          cd private_setfilmizledizi
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "SetFilmÄ°zleDizi Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # DiziYo
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/diziyo.git private_diziyo
          rsync -a diziyo/ private_diziyo/
          cd private_diziyo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "DiziYo Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # DiziPall
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/dizipall.git private_dizipall
          rsync -a dizipall/ private_dizipall/
          cd private_dizipall
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "DiziPall Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # HDFilmsite
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/hdfilmsitedizi.git private_hdfilmsitedizi
          rsync -a yereldiziler/ private_hdfilmsitedizi/
          cd private_hdfilmsitedizi
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "HDFilmsite Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # HDFilmCehennemi
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/hdfilmcehennemi.git private_hdfilmcehennemi
          rsync -a hdfilmcehennemi/ private_hdfilmcehennemi/
          cd private_hdfilmcehennemi
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "HDFilmCehennemi Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # YabancÄ±Diziler
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/yabancidiziler.git private_yabancidiziler
          rsync -a yabancidiziler/ private_yabancidiziler/
          cd private_yabancidiziler
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "YabanciDiziler Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # SezonlukDÄ°zi
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/sezonlukdizi.git private_sezonlukdizi
          rsync -a sdizi/ private_sezonlukdizi/
          cd private_sezonlukdizi
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "SezonlukDizi Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # Dizipal
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/dizipal.git private_dizipal
          rsync -a dizipal/ private_dizipal/
          cd private_dizipal
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "Dizipal Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # AnimeHeaven
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/animeheaven.git private_animeheaven
          rsync -a animeheaven/ private_animeheaven/
          cd private_animeheaven
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "AnimeHeaven Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..

          # Dizilife
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/m3u8file.git private_m3u8filee
          rsync -a dizilife/ private_m3u8filee/
          cd private_m3u8filee
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add . || echo "No files"
          git commit -m "Dizilife Ã§Ä±ktÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main
          cd ..
          
  part4:
    name: Step 15 Ã‡alÄ±ÅŸtÄ±r
    runs-on: ubuntu-latest
    needs: part3
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      # 15. YeniJSON to AnaJSON
      - name: Run yenibolumdenanajsona Script
        run: python private_py/series/yenibolumdenanajsona.py

      - name: Commit and Push Ana JSONs to public repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add */*.json || echo "No files"
          git commit -m "All Ana JSON gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main

  part5:
    name: Step 16-to-19 Ã‡alÄ±ÅŸtÄ±r
    runs-on: ubuntu-latest
    needs: part4
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      - name: Install Shared Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml aiohttp aiofiles dotenv playwright
          playwright install
       
      # 16. Dizizgom Filmler
      - name: Run dizigomfilmler Script
        run: python private_py/movies/dizigom/dizigomfilmler.py

      # 17. SetFilmÄ°zle Filmler
      - name: Run Setfilm Script
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: python private_py/movies/setfilmizle/ilksayfatÃ¼mm3uolusturma.py

      # 18. HDFilm YabancÄ± ve Yerli Filmler
      - name: Run HDFilm YabancÄ± ve Yerli Filmler Script
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: python private_py/movies/hdfilmsite/hemyabancihemdeyerli.py

      - name: Sync Filmler outputs to private m3u8file repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/m3u8file.git privatate_m3u8file
          cp dizigomfilmler.m3u privatate_m3u8file/dizigomfilmler.m3u || echo "dizigomfilmler.m3u bulunamadÄ±"
          cp xtream/setfilmizlefilmler.m3u privatate_m3u8file/setfilmizlefilmler.m3u || echo "setfilmizlefilmler.m3u bulunamadÄ±"
          cp hdfilmsite.m3u privatate_m3u8file/hdfilmsite.m3u || echo "hdfilmsite.m3u bulunamadÄ±"
          cd privatate_m3u8file
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add setfilmizlefilmler.m3u dizigomfilmler.m3u hdfilmsite.m3u
          git commit -m "Filmlerin Ã§Ä±ktÄ±sÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          git push origin main

      - name: Telegram Success Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        if: success()
        run: |
          MESSAGE="âœ… M3U dosyalarÄ± baÅŸarÄ±yla gÃ¼ncellendi!"
          curl -s -o /dev/null -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE"
